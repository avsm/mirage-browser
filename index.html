<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>Mirage Browser</title>
    <link type="text/css" href="css/humanity/jquery-ui-1.8.14.custom.css" rel="stylesheet" />  
    <link type="text/css" href="css/layout-default-latest.css" rel="stylesheet" />  
    <script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
    <script type="text/javascript" src="js/jquery.jstree.js"></script>
    <script type="text/javascript">

  $(document).ready(function () {
    function signame(x) { return ('sig'+x); }
    function modname(x) { return ('mod'+x); }

    function generateSigFun(modname, v) {
      var f = $("<div />").addClass('sig-fun');
      var fnname = v.name.replace(modname+'.','');
      f.append(
        $("<div/>").addClass('sig-fun-type').html(
          $("<span/>").addClass('sig-fun-type-start').text('val '+fnname+' : '),
          $("<span/>").addClass('sig-fun-type-body').text(v.type)
        )
      );
      f.append($("<div />").addClass('sig-fun-descr').html(v.info.description));
      return f;
    }
    function generateSig(sigdata) {
      var name = sigdata.module.name;
      var modstruct = sigdata.module.module_structure;
      var d = $("<div />").attr('id', signame(name));
      d.append($("<div />").addClass('sig-header').text(sigdata.module.name));
      d.append($("<div />").addClass('sig-info').html(sigdata.module.info.description));
      $.each(sigdata.module.module_structure, function(e) {
         var x = sigdata.module.module_structure[e];
         if (x.comment) {
           d.append($("<div />").addClass('sig-comment').html(x.comment));
         } else if (x.value) {
           d.append(generateSigFun(name, x.value));
         }
       });
      return d;
    }

    $('#sigs').hide();

    function renderTree(data) {
      $('#thetree').jstree({
        core: { animation: 20 },
        plugins: ['themes', 'json_data', 'ui', 'search'],
        themes: { icons: true, dots: true },
        search: { show_only_matches: true, case_insensitive: true, },
        UI: { select_limit:-1 },
        json_data: { 'data' : data.tree }
      }).bind("select_node.jstree", function (e, id) { 
        var a = $.jstree._focused().get_selected()[0].id.replace(/^tree/,"");
        var e = $('#'+signame(a)).clone();
        $('#center').html(e);
      });
      $('#modsearch').keyup(function (e) { 
        var v = $('#modsearch').val();
        if (v == '') {
          $('#thetree').jstree('clear_search');
        } else {
          $('#thetree').jstree('search', v);
        }
      });
    }

    $.ajax({
      url: 'data/info.json',
      dataType: 'json',
      error: function(x) { console.log('ERR'+x); },
      success: function(data) {
        renderTree(data);
        $.each(data.info, function(m) {
          $('#sigs').append(generateSig(data.info[m]));
        });
      }
    });
   });
    </script>
   
  </head>
  <body>
   <div id="sigs"></div>
   <div id="container">
     <div id="left" class="column">
       <form>
         <input type="text" name="modsearch" id="modsearch" />
       </form>
       <div id="thetree"></div>
      </div>
     <div id="center" class="column">
     </div>
   </div>
 </body>
</html>
